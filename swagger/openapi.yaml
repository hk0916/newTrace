openapi: 3.0.3

info:
  title: TraceTag Platform API
  version: 1.0.0
  description: |
    BLE 자산 추적 플랫폼 REST API

    ## 인증
    NextAuth.js 기반 쿠키 세션 인증 (`/login` 에서 로그인).
    모든 보호된 엔드포인트는 유효한 세션 쿠키가 필요합니다.

    ## 권한 레벨
    - **user**: 조회 전용
    - **admin**: 회사 데이터 전체 관리
    - **super**: 모든 회사 접근 가능, 시스템 전체 관리

servers:
  - url: http://localhost:3000/api
    description: 로컬 개발 서버
  - url: https://tracetaghub.io/api
    description: 운영 서버

security:
  - cookieAuth: []

tags:
  - name: Gateways
    description: 게이트웨이 등록 및 관리
  - name: Tags
    description: BLE 태그 등록 및 센싱 데이터
  - name: Companies
    description: 회사(테넌트) 관리
  - name: Dashboard
    description: 대시보드 통계
  - name: Alerts
    description: 알림 설정, 조회, 히스토리
  - name: Asset Maps
    description: 자산맵 생성 및 게이트웨이 배치
  - name: Register
    description: 게이트웨이/태그 일괄 등록
  - name: Gateway Control
    description: 게이트웨이 원격 제어
  - name: User
    description: 사용자 개인 설정

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: authjs.session-token
      description: NextAuth.js 세션 쿠키 (로그인 후 자동 설정)

  schemas:
    # ─── 공통 ───────────────────────────────────────────────────────────
    Error:
      type: object
      properties:
        error:
          type: string
          example: 인증이 필요합니다

    Success:
      type: object
      properties:
        success:
          type: boolean
          example: true

    MacAddress:
      type: string
      pattern: '^[0-9A-Fa-f]{12}$'
      example: AABBCCDDEEFF
      description: 콜론 없는 12자리 16진수 MAC 주소

    # ─── 게이트웨이 ──────────────────────────────────────────────────────
    GatewayListItem:
      type: object
      properties:
        gwMac:
          $ref: '#/components/schemas/MacAddress'
        gwName:
          type: string
          example: GW-Building-A
        companyId:
          type: string
          example: skaichips
        location:
          type: string
          nullable: true
          example: 1층 로비
        description:
          type: string
          nullable: true
        isActive:
          type: boolean
        hwVersion:
          type: string
          nullable: true
          example: HW_1.0
        fwVersion:
          type: string
          nullable: true
          example: FW_2.1
        isConnected:
          type: boolean
          nullable: true
        ipAddress:
          type: string
          nullable: true
          example: 192.168.1.100
        port:
          type: integer
          nullable: true
        reportInterval:
          type: integer
          nullable: true
          description: 보고 주기 (초)
        rssiFilter:
          type: integer
          nullable: true
          description: RSSI 필터 값
        otaServerUrl:
          type: string
          nullable: true
        wsServerUrl:
          type: string
          nullable: true
        lastConnectedAt:
          type: string
          format: date-time
          nullable: true
        tagCount:
          type: integer
          example: 5

    GatewayDetail:
      allOf:
        - $ref: '#/components/schemas/GatewayListItem'
        - type: object
          properties:
            registeredAt:
              type: string
              format: date-time
            lastUpdatedAt:
              type: string
              format: date-time
              nullable: true
            tags:
              type: array
              items:
                $ref: '#/components/schemas/TagListItem'

    GatewayCreate:
      type: object
      required: [gwMac, gwName]
      properties:
        gwMac:
          $ref: '#/components/schemas/MacAddress'
        gwName:
          type: string
          minLength: 1
          maxLength: 100
          example: GW-Building-A
        location:
          type: string
          maxLength: 255
          nullable: true
        description:
          type: string
          nullable: true

    GatewayUpdate:
      type: object
      required: [gwName]
      properties:
        gwName:
          type: string
          minLength: 1
          maxLength: 100
        location:
          type: string
          nullable: true
        description:
          type: string
          nullable: true
        isActive:
          type: boolean

    # ─── 태그 ────────────────────────────────────────────────────────────
    LatestSensing:
      type: object
      nullable: true
      properties:
        gwMac:
          $ref: '#/components/schemas/MacAddress'
        temperature:
          type: string
          nullable: true
          example: '23.50'
        voltage:
          type: string
          nullable: true
          example: '2.85'
        rssi:
          type: integer
          nullable: true
          example: -65
        receivedTime:
          type: string
          format: date-time
          nullable: true

    TagListItem:
      type: object
      properties:
        tagMac:
          $ref: '#/components/schemas/MacAddress'
        tagName:
          type: string
          example: Tag-Pallet-001
        companyId:
          type: string
        assignedGwMac:
          $ref: '#/components/schemas/MacAddress'
          nullable: true
        reportInterval:
          type: integer
          example: 60
        assetType:
          type: string
          nullable: true
          example: 팔레트
        description:
          type: string
          nullable: true
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        latestSensing:
          $ref: '#/components/schemas/LatestSensing'

    TagDetail:
      allOf:
        - $ref: '#/components/schemas/TagListItem'
        - type: object
          properties:
            recentSensing:
              type: array
              items:
                $ref: '#/components/schemas/SensingData'

    TagCreate:
      type: object
      required: [tagMac, tagName]
      properties:
        tagMac:
          $ref: '#/components/schemas/MacAddress'
        tagName:
          type: string
          minLength: 1
          maxLength: 100
        assignedGwMac:
          $ref: '#/components/schemas/MacAddress'
          nullable: true
        reportInterval:
          type: integer
          minimum: 1
          default: 60
        assetType:
          type: string
          nullable: true
        description:
          type: string
          nullable: true

    TagUpdate:
      type: object
      required: [tagName]
      properties:
        tagName:
          type: string
          minLength: 1
          maxLength: 100
        assignedGwMac:
          $ref: '#/components/schemas/MacAddress'
          nullable: true
        reportInterval:
          type: integer
          minimum: 1
        assetType:
          type: string
          nullable: true
        description:
          type: string
          nullable: true
        isActive:
          type: boolean

    SensingData:
      type: object
      properties:
        id:
          type: string
        tagMac:
          $ref: '#/components/schemas/MacAddress'
        gwMac:
          $ref: '#/components/schemas/MacAddress'
        temperature:
          type: string
          nullable: true
          example: '23.50'
        voltage:
          type: string
          nullable: true
          example: '2.85'
        rssi:
          type: integer
          nullable: true
        rawAdvData:
          type: string
          nullable: true
        receivedAt:
          type: string
          format: date-time

    # ─── 회사 ────────────────────────────────────────────────────────────
    Company:
      type: object
      properties:
        id:
          type: string
          example: skaichips
        name:
          type: string
          example: SKAI Chips
        timezone:
          type: string
          example: Asia/Seoul

    # ─── 알림 ────────────────────────────────────────────────────────────
    Alert:
      type: object
      properties:
        type:
          type: string
          enum: [gw_disconnected, tag_stale, high_temp, low_temp, low_voltage]
        key:
          type: string
          description: 고유 식별자 (gwMac 또는 tagMac)
        title:
          type: string
          example: 게이트웨이 연결 끊김
        message:
          type: string
          example: GW-A (AABBCCDDEEFF) 연결이 끊어졌습니다
        since:
          type: string
          format: date-time

    AlertHistory:
      type: object
      properties:
        id:
          type: string
        companyId:
          type: string
        alertType:
          type: string
          enum: [gw_disconnected, tag_stale, high_temp, low_temp, low_voltage]
        alertKey:
          type: string
        alertName:
          type: string
        alertMessage:
          type: string
        triggeredAt:
          type: string
          format: date-time
        acknowledgedAt:
          type: string
          format: date-time
          nullable: true
        acknowledgedBy:
          type: string
          nullable: true
        resolvedAt:
          type: string
          format: date-time
          nullable: true

    AlertSettings:
      type: object
      properties:
        companyId:
          type: string
        lowVoltageThreshold:
          type: number
          example: 2.5
          description: 저전압 임계값 (V)
        highTempThreshold:
          type: number
          example: 40.0
          description: 고온 임계값 (°C)
        lowTempThreshold:
          type: number
          example: 0.0
          description: 저온 임계값 (°C)
        enableLowVoltageAlert:
          type: boolean
        enableHighTempAlert:
          type: boolean
        enableLowTempAlert:
          type: boolean
        tagLastUpdateHours:
          type: number
          example: 2
          description: 태그 미갱신 경보 시간 (시간)
        gwDisconnectHours:
          type: number
          example: 0.5
          description: 게이트웨이 연결 끊김 경보 시간 (시간)
        enableTagHeartbeatAlert:
          type: boolean
        enableGwDisconnectAlert:
          type: boolean

    # ─── 자산맵 ──────────────────────────────────────────────────────────
    AssetMapListItem:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        imagePath:
          type: string
          example: /uploads/maps/map-uuid.jpg
        imageWidth:
          type: integer
        imageHeight:
          type: integer
        showOnDashboard:
          type: boolean
        gatewayCount:
          type: integer
        createdAt:
          type: string
          format: date-time

    GatewayPlacement:
      type: object
      properties:
        id:
          type: string
        gwMac:
          $ref: '#/components/schemas/MacAddress'
        gwName:
          type: string
        xPercent:
          type: number
          description: 맵 기준 X 위치 (%)
          example: 25.5
        yPercent:
          type: number
          description: 맵 기준 Y 위치 (%)
          example: 30.0
        widthPercent:
          type: number
          description: 너비 (%)
          example: 10.0
        heightPercent:
          type: number
          description: 높이 (%)
          example: 8.0
        color:
          type: string
          enum: [amber, emerald, rose, cyan, violet, lime]
          default: amber
        isConnected:
          type: boolean
        tagCount:
          type: integer

    AssetMapDetail:
      allOf:
        - $ref: '#/components/schemas/AssetMapListItem'
        - type: object
          properties:
            gatewayAreaColor:
              type: string
              enum: [amber, emerald, rose, cyan, violet, lime]
              deprecated: true
              description: 더 이상 사용되지 않음 - 각 placement의 color 필드 사용
            placements:
              type: array
              items:
                $ref: '#/components/schemas/GatewayPlacement'

    # ─── 일괄 등록 ────────────────────────────────────────────────────────
    BulkRegisterResult:
      type: object
      properties:
        gateways:
          type: object
          properties:
            success:
              type: integer
            fail:
              type: integer
            errors:
              type: array
              items:
                type: string
        tags:
          type: object
          properties:
            success:
              type: integer
            fail:
              type: integer
            errors:
              type: array
              items:
                type: string

paths:
  # ════════════════════════════════════════════════════════════
  # GATEWAYS
  # ════════════════════════════════════════════════════════════
  /gateways:
    get:
      tags: [Gateways]
      summary: 게이트웨이 목록 조회
      parameters:
        - name: companyId
          in: query
          description: 회사 ID (super 역할 전용, 일반 사용자는 세션에서 자동 해석)
          schema:
            type: string
        - name: search
          in: query
          description: MAC, 이름, 위치로 검색
          schema:
            type: string
        - name: order
          in: query
          description: 정렬 순서
          schema:
            type: string
            enum: [asc, desc]
            default: desc
        - name: gwMac
          in: query
          description: 특정 MAC 주소 필터
          schema:
            $ref: '#/components/schemas/MacAddress'
      responses:
        '200':
          description: 게이트웨이 목록
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/GatewayListItem'
        '401':
          description: 인증 필요
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      tags: [Gateways]
      summary: 게이트웨이 등록
      description: admin 또는 super 권한 필요
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GatewayCreate'
      responses:
        '201':
          description: 등록 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GatewayListItem'
        '400':
          description: 잘못된 요청 (MAC 형식 오류, 중복 등)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: 권한 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /gateways/{gwMac}:
    parameters:
      - name: gwMac
        in: path
        required: true
        description: 게이트웨이 MAC 주소 (12자리 hex)
        schema:
          $ref: '#/components/schemas/MacAddress'

    get:
      tags: [Gateways]
      summary: 게이트웨이 상세 조회
      description: 연결된 태그 목록 포함
      responses:
        '200':
          description: 게이트웨이 상세 정보
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GatewayDetail'
        '404':
          description: 게이트웨이 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags: [Gateways]
      summary: 게이트웨이 정보 수정
      description: admin 또는 super 권한 필요
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GatewayUpdate'
      responses:
        '200':
          description: 수정 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GatewayListItem'
        '404':
          description: 게이트웨이 없음

    delete:
      tags: [Gateways]
      summary: 게이트웨이 삭제
      description: admin 또는 super 권한 필요. 연결된 태그의 assignedGwMac이 null로 해제됩니다.
      responses:
        '200':
          description: 삭제 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted:
                    type: string
                    description: 삭제된 gwMac
        '404':
          description: 게이트웨이 없음

  # ════════════════════════════════════════════════════════════
  # TAGS
  # ════════════════════════════════════════════════════════════
  /tags:
    get:
      tags: [Tags]
      summary: 태그 목록 조회
      parameters:
        - name: companyId
          in: query
          description: 회사 ID (super 전용)
          schema:
            type: string
        - name: gwMac
          in: query
          description: 특정 게이트웨이에 할당된 태그만 조회
          schema:
            $ref: '#/components/schemas/MacAddress'
        - name: search
          in: query
          description: MAC, 이름, assetType으로 검색
          schema:
            type: string
        - name: order
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: 태그 목록
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TagListItem'

    post:
      tags: [Tags]
      summary: 태그 등록
      description: admin 또는 super 권한 필요
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TagCreate'
      responses:
        '201':
          description: 등록 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TagListItem'
        '400':
          description: 잘못된 요청
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /tags/{tagMac}:
    parameters:
      - name: tagMac
        in: path
        required: true
        description: 태그 MAC 주소 (12자리 hex)
        schema:
          $ref: '#/components/schemas/MacAddress'

    get:
      tags: [Tags]
      summary: 태그 상세 조회
      description: 최근 10개 센싱 데이터 포함
      responses:
        '200':
          description: 태그 상세 정보
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TagDetail'
        '404':
          description: 태그 없음

    put:
      tags: [Tags]
      summary: 태그 정보 수정
      description: admin 또는 super 권한 필요
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TagUpdate'
      responses:
        '200':
          description: 수정 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TagListItem'

    delete:
      tags: [Tags]
      summary: 태그 삭제
      description: admin 또는 super 권한 필요. 센싱 데이터도 함께 삭제됩니다.
      responses:
        '200':
          description: 삭제 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted:
                    type: string

  /tags/{tagMac}/sensing:
    parameters:
      - name: tagMac
        in: path
        required: true
        schema:
          $ref: '#/components/schemas/MacAddress'

    get:
      tags: [Tags]
      summary: 태그 센싱 데이터 조회
      description: 페이지네이션 지원. 온도, 전압, RSSI 이력 조회.
      parameters:
        - name: limit
          in: query
          description: 조회 건수 (최대 200)
          schema:
            type: integer
            default: 50
            maximum: 200
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
        - name: from
          in: query
          description: 시작 시각 (ISO 8601)
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          description: 종료 시각 (ISO 8601)
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: 센싱 데이터 목록
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/SensingData'
                  limit:
                    type: integer
                  offset:
                    type: integer

  # ════════════════════════════════════════════════════════════
  # COMPANIES
  # ════════════════════════════════════════════════════════════
  /companies:
    get:
      tags: [Companies]
      summary: 회사 목록 조회
      description: super 역할은 모든 회사, 일반 사용자는 본인 회사만 반환
      responses:
        '200':
          description: 회사 목록
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Company'

    post:
      tags: [Companies]
      summary: 회사 생성
      description: super 권한 전용
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  example: New Company
      responses:
        '201':
          description: 생성 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Company'
        '403':
          description: super 권한 필요

  /company-settings:
    get:
      tags: [Companies]
      summary: 회사 타임존 설정 조회
      parameters:
        - name: companyId
          in: query
          description: 회사 ID (super 전용, 일반 사용자는 세션에서 자동)
          schema:
            type: string
      responses:
        '200':
          description: 타임존 설정
          content:
            application/json:
              schema:
                type: object
                properties:
                  timezone:
                    type: string
                    example: Asia/Seoul
                    description: IANA 타임존 또는 'browser'

    put:
      tags: [Companies]
      summary: 회사 타임존 설정 변경
      description: admin 또는 super 권한 필요
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [companyId, timezone]
              properties:
                companyId:
                  type: string
                timezone:
                  type: string
                  example: Asia/Seoul
                  description: IANA 타임존 문자열 또는 'browser'
      responses:
        '200':
          description: 수정 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  timezone:
                    type: string

  # ════════════════════════════════════════════════════════════
  # DASHBOARD
  # ════════════════════════════════════════════════════════════
  /dashboard/stats:
    get:
      tags: [Dashboard]
      summary: 대시보드 통계 조회
      description: 게이트웨이, 태그 수량 및 알림 카운트 반환
      parameters:
        - name: companyId
          in: query
          description: 회사 ID (super 전용)
          schema:
            type: string
      responses:
        '200':
          description: 통계 데이터
          content:
            application/json:
              schema:
                type: object
                properties:
                  gateways:
                    type: object
                    properties:
                      total:
                        type: integer
                      active:
                        type: integer
                      connected:
                        type: integer
                  tags:
                    type: object
                    properties:
                      total:
                        type: integer
                      active:
                        type: integer
                  alerts:
                    type: object
                    properties:
                      lowVoltage:
                        type: integer

  # ════════════════════════════════════════════════════════════
  # ALERTS
  # ════════════════════════════════════════════════════════════
  /alerts:
    get:
      tags: [Alerts]
      summary: 현재 활성 알림 조회
      description: |
        알림 설정에 따라 필터링된 현재 알림 반환.
        현재 세션에서 이미 확인한 알림은 제외됩니다.
        호출 시 새 알림이 자동으로 히스토리에 기록됩니다.
      parameters:
        - name: companyId
          in: query
          schema:
            type: string
      responses:
        '200':
          description: 활성 알림 목록
          content:
            application/json:
              schema:
                type: object
                properties:
                  alerts:
                    type: array
                    items:
                      $ref: '#/components/schemas/Alert'
                  count:
                    type: integer

  /alerts/acknowledge:
    post:
      tags: [Alerts]
      summary: 알림 확인 처리
      description: |
        알림을 확인 처리합니다.
        세션 스코프 (JWT iat 기반) — 다음 로그인 전까지 해당 알림이 재표시되지 않습니다.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [companyId, keys]
              properties:
                companyId:
                  type: string
                keys:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                        enum: [gw_disconnected, tag_stale, high_temp, low_temp, low_voltage]
                      key:
                        type: string
                        description: gwMac 또는 tagMac
      responses:
        '200':
          description: 확인 처리 완료
          content:
            application/json:
              schema:
                type: object
                properties:
                  acknowledged:
                    type: integer
                    description: 처리된 알림 수

  /alerts/history:
    get:
      tags: [Alerts]
      summary: 알림 히스토리 조회
      parameters:
        - name: companyId
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 200
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: 알림 히스토리
          content:
            application/json:
              schema:
                type: object
                properties:
                  history:
                    type: array
                    items:
                      $ref: '#/components/schemas/AlertHistory'

  /alert-settings:
    get:
      tags: [Alerts]
      summary: 알림 설정 조회
      parameters:
        - name: companyId
          in: query
          schema:
            type: string
      responses:
        '200':
          description: 알림 설정
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertSettings'

    put:
      tags: [Alerts]
      summary: 알림 설정 수정
      description: admin 또는 super 권한 필요
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AlertSettings'
      responses:
        '200':
          description: 수정 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertSettings'

  # ════════════════════════════════════════════════════════════
  # ASSET MAPS
  # ════════════════════════════════════════════════════════════
  /asset-maps:
    get:
      tags: [Asset Maps]
      summary: 자산맵 목록 조회
      parameters:
        - name: companyId
          in: query
          schema:
            type: string
      responses:
        '200':
          description: 자산맵 목록
          content:
            application/json:
              schema:
                type: object
                properties:
                  maps:
                    type: array
                    items:
                      $ref: '#/components/schemas/AssetMapListItem'

    post:
      tags: [Asset Maps]
      summary: 자산맵 생성 (이미지 업로드)
      description: |
        admin 또는 super 권한 필요.
        JPG/PNG/WebP 이미지 업로드, 최대 10MB.
        이미지는 최대 1920px로 자동 리사이즈됩니다.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file, name]
              properties:
                file:
                  type: string
                  format: binary
                  description: 도면 이미지 (JPG/PNG/WebP, 최대 10MB)
                name:
                  type: string
                  description: 맵 이름
                  example: 1층 평면도
                companyId:
                  type: string
                  description: 회사 ID (super 전용)
      responses:
        '201':
          description: 생성 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssetMapListItem'

  /asset-maps/{mapId}:
    parameters:
      - name: mapId
        in: path
        required: true
        description: 자산맵 ID
        schema:
          type: string

    get:
      tags: [Asset Maps]
      summary: 자산맵 상세 조회
      description: 게이트웨이 배치 정보 포함
      responses:
        '200':
          description: 자산맵 상세
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssetMapDetail'

    put:
      tags: [Asset Maps]
      summary: 자산맵 정보 수정
      description: 이름 또는 게이트웨이 영역 색상 변경
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                gatewayAreaColor:
                  type: string
                  enum: [amber, emerald, rose, cyan, violet, lime]
      responses:
        '200':
          description: 수정 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssetMapDetail'

    delete:
      tags: [Asset Maps]
      summary: 자산맵 삭제
      description: admin 또는 super 권한 필요. 이미지 파일과 배치 정보도 함께 삭제됩니다.
      responses:
        '200':
          description: 삭제 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'

  /asset-maps/{mapId}/placements:
    parameters:
      - name: mapId
        in: path
        required: true
        schema:
          type: string

    put:
      tags: [Asset Maps]
      summary: 맵 게이트웨이 배치 전체 저장
      description: |
        admin 또는 super 권한 필요.
        기존 배치를 모두 삭제하고 새로 삽입 (트랜잭션).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [placements]
              properties:
                placements:
                  type: array
                  items:
                    type: object
                    required: [gwMac, xPercent, yPercent, widthPercent, heightPercent]
                    properties:
                      gwMac:
                        $ref: '#/components/schemas/MacAddress'
                      xPercent:
                        type: number
                        minimum: 0
                        maximum: 100
                      yPercent:
                        type: number
                        minimum: 0
                        maximum: 100
                      widthPercent:
                        type: number
                        minimum: 1
                        maximum: 100
                      heightPercent:
                        type: number
                        minimum: 1
                        maximum: 100
                      color:
                        type: string
                        enum: [amber, emerald, rose, cyan, violet, lime]
                        default: amber
      responses:
        '200':
          description: 저장 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
                    description: 저장된 배치 수

  /asset-maps/{mapId}/placements/{placementId}:
    parameters:
      - name: mapId
        in: path
        required: true
        schema:
          type: string
      - name: placementId
        in: path
        required: true
        schema:
          type: string

    delete:
      tags: [Asset Maps]
      summary: 특정 게이트웨이 배치 삭제
      description: admin 또는 super 권한 필요
      responses:
        '200':
          description: 삭제 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'

  /asset-maps/{mapId}/set-dashboard:
    parameters:
      - name: mapId
        in: path
        required: true
        schema:
          type: string

    post:
      tags: [Asset Maps]
      summary: 대시보드 표시 여부 토글
      description: |
        admin 또는 super 권한 필요.
        같은 회사의 다른 맵은 대시보드에서 해제됩니다 (회사당 1개).
      parameters:
        - name: companyId
          in: query
          schema:
            type: string
      responses:
        '200':
          description: 토글 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  showOnDashboard:
                    type: boolean
                    description: 변경 후 값

  # ════════════════════════════════════════════════════════════
  # REGISTER (BULK)
  # ════════════════════════════════════════════════════════════
  /register/template:
    get:
      tags: [Register]
      summary: 일괄 등록 엑셀 템플릿 다운로드
      description: |
        admin 또는 super 권한 필요.
        시트1: 게이트웨이 (MAC주소, 이름, [회사ID])
        시트2: 태그 (MAC주소, 이름, [회사ID], 보고주기(초))
      responses:
        '200':
          description: Excel 파일 (.xlsx)
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary

  /register/bulk:
    post:
      tags: [Register]
      summary: 게이트웨이/태그 일괄 등록
      description: |
        admin 또는 super 권한 필요.
        템플릿 형식의 Excel 파일을 업로드해 일괄 등록합니다.
        오류가 있는 행은 건너뛰고 나머지는 등록됩니다.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
                  description: 등록 Excel 파일 (.xlsx)
      responses:
        '200':
          description: 일괄 등록 결과
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulkRegisterResult'

  # ════════════════════════════════════════════════════════════
  # GATEWAY CONTROL
  # ════════════════════════════════════════════════════════════
  /gateway-control/command:
    post:
      tags: [Gateway Control]
      summary: 게이트웨이 명령 전송
      description: |
        admin 또는 super 권한 필요.
        WebSocket 서버(포트 8081)를 통해 게이트웨이로 명령을 전송합니다.
        `gwMac`에 'all' 지정 시 모든 연결된 게이트웨이로 브로드캐스트.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [gwMac, command]
              properties:
                gwMac:
                  type: string
                  description: 대상 게이트웨이 MAC 또는 'all'
                  example: AABBCCDDEEFF
                command:
                  type: string
                  description: 전송할 명령
                  example: reboot
                payload:
                  type: object
                  description: 추가 페이로드 (선택)
      responses:
        '200':
          description: 명령 전송 결과
          content:
            application/json:
              schema:
                type: object

  # ════════════════════════════════════════════════════════════
  # USER
  # ════════════════════════════════════════════════════════════
  /user/locale:
    put:
      tags: [User]
      summary: 사용자 언어 설정 변경
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [locale]
              properties:
                locale:
                  type: string
                  enum: [ko, en]
                  example: ko
      responses:
        '200':
          description: 변경 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean

  /user/password:
    put:
      tags: [User]
      summary: 비밀번호 변경
      description: |
        현재 비밀번호를 확인 후 새 비밀번호로 변경합니다.
        임시 비밀번호(Tracetag2024!)로 로그인한 경우 강제 변경 페이지로 리다이렉트됩니다.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [currentPassword, newPassword]
              properties:
                currentPassword:
                  type: string
                  example: Tracetag2024!
                newPassword:
                  type: string
                  minLength: 6
                  example: MyNewPassword123
      responses:
        '200':
          description: 변경 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'
        '400':
          description: 현재 비밀번호 불일치 또는 유효성 오류
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
