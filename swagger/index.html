<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TraceTag API Docs</title>
  <link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist@5/swagger-ui.css" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }

    /* ìƒë‹¨ í—¤ë” */
    #header {
      background: #1a1a2e;
      color: #fff;
      padding: 14px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    #header h1 { font-size: 18px; font-weight: 600; letter-spacing: 0.5px; }
    #header span { font-size: 12px; color: #aaa; }

    /* ì„œë²„ ì„ íƒ */
    #server-bar {
      background: #16213e;
      padding: 10px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid #0f3460;
      flex-wrap: wrap;
    }
    #server-bar label { color: #ccc; font-size: 13px; white-space: nowrap; }
    #server-select {
      background: #0f3460;
      color: #fff;
      border: 1px solid #4a4a8a;
      border-radius: 6px;
      padding: 5px 10px;
      font-size: 13px;
      cursor: pointer;
    }
    #server-select:focus { outline: none; border-color: #7a7aff; }

    /* ìš´ì˜ ì„œë²„ ê²½ê³  ë°°ë„ˆ */
    #prod-warning {
      display: none;
      background: #7c2d12;
      color: #fef3c7;
      border: 1px solid #dc2626;
      border-radius: 6px;
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 500;
      align-items: center;
      gap: 6px;
    }
    #prod-warning.show { display: flex; }

    /* ë©”ì¸ ì»¨í…ì¸  */
    #swagger-ui { max-width: 1200px; margin: 0 auto; }

    /* Swagger UI ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
    .swagger-ui .topbar { display: none !important; }
    .swagger-ui .info { margin: 20px 0; }
    .swagger-ui .info .title { font-size: 26px; }
    .swagger-ui .scheme-container { background: #fafafa; padding: 12px; border-radius: 8px; margin: 12px 0; }
    .swagger-ui .opblock-tag { font-size: 16px; }
    .swagger-ui .btn.authorize { background: #1a1a2e; border-color: #1a1a2e; }
    .swagger-ui .btn.authorize svg { fill: #fff; }
  </style>
</head>
<body>

<div id="header">
  <h1>ğŸ“¡ TraceTag Platform API</h1>
  <span>BLE Asset Tracking Â· OpenAPI 3.0</span>
</div>

<div id="server-bar">
  <label for="server-select">ì„œë²„ ì„ íƒ:</label>
  <select id="server-select">
    <option value="http://localhost:3000/api">ğŸ–¥ï¸ ë¡œì»¬ ê°œë°œ (localhost:3000)</option>
    <option value="https://tracetaghub.io/api">ğŸŒ ìš´ì˜ ì„œë²„ (tracetaghub.io)</option>
    <option value="http://211.38.153.203:3000/api">ğŸ”§ ìš´ì˜ ì„œë²„ IP ì§ì ‘ ì ‘ê·¼</option>
  </select>
  <div id="prod-warning">
    âš ï¸ ìš´ì˜ ì„œë²„ â€” ì¡°íšŒ(GET)ë§Œ í—ˆìš©ë©ë‹ˆë‹¤. ë°ì´í„° ë³€ê²½ ìš”ì²­ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.
  </div>
</div>

<div id="swagger-ui"></div>

<script src="https://unpkg.com/swagger-ui-dist@5/swagger-ui-bundle.js"></script>
<script src="https://unpkg.com/swagger-ui-dist@5/swagger-ui-standalone-preset.js"></script>
<script src="https://unpkg.com/js-yaml@4/dist/js-yaml.min.js"></script>
<script>

// openapi.yaml ì„ fetchí•´ì„œ ë¡œë“œ
async function loadSpec() {
  // ë¡œì»¬ íŒŒì¼ë¡œ ì—´ì—ˆì„ ë•Œì™€ HTTP ì„œë²„ë¡œ ì„œë¹™ë  ë•Œ ëª¨ë‘ ì§€ì›
  let specUrl = './openapi.yaml';

  // í˜„ì¬ ì„ íƒëœ ì„œë²„
  const serverSelect = document.getElementById('server-select');
  const prodWarning = document.getElementById('prod-warning');

  // ìš´ì˜ ì„œë²„ URL ëª©ë¡ (GETë§Œ í—ˆìš©)
  const PROD_SERVERS = [
    'https://tracetaghub.io/api',
    'http://211.38.153.203:3000/api',
  ];

  function getSelectedServer() {
    return serverSelect.value;
  }

  function isProdServer() {
    return PROD_SERVERS.includes(getSelectedServer());
  }

  function updateProdWarning() {
    if (isProdServer()) {
      prodWarning.classList.add('show');
    } else {
      prodWarning.classList.remove('show');
    }
  }

  try {
    const res = await fetch(specUrl);
    const yamlText = await res.text();
    const spec = jsyaml.load(yamlText);

    // ì„ íƒëœ ì„œë²„ë¥¼ specì— ë°˜ì˜
    function buildSpec() {
      const selectedServer = getSelectedServer();
      return {
        ...spec,
        servers: [
          { url: selectedServer, description: 'í˜„ì¬ ì„ íƒëœ ì„œë²„' },
          ...spec.servers.filter(s => s.url !== selectedServer)
        ]
      };
    }

    let ui;

    function initUI() {
      if (ui) ui = null;
      const currentSpec = buildSpec();
      const prod = isProdServer();

      updateProdWarning();

      ui = SwaggerUIBundle({
        spec: currentSpec,
        dom_id: '#swagger-ui',
        presets: [
          SwaggerUIBundle.presets.apis,
          SwaggerUIStandalonePreset
        ],
        layout: 'StandaloneLayout',
        deepLinking: true,
        displayRequestDuration: true,
        filter: true,
        tryItOutEnabled: true,
        // ìš´ì˜ ì„œë²„ëŠ” GET ì¡°íšŒë§Œ í—ˆìš©
        supportedSubmitMethods: prod ? ['get'] : ['get', 'post', 'put', 'delete', 'patch'],
        withCredentials: true,  // ì¿ í‚¤ ì¸ì¦ (ì„¸ì…˜ í¬í•¨)
        requestInterceptor: (req) => {
          return req;
        },
      });
    }

    initUI();

    // ì„œë²„ ë³€ê²½ ì‹œ ì¬ì´ˆê¸°í™”
    serverSelect.addEventListener('change', () => {
      document.getElementById('swagger-ui').innerHTML = '';
      initUI();
    });

  } catch (err) {
    // fetch ì‹¤íŒ¨ ì‹œ (file:// í”„ë¡œí† ì½œ) â€” YAMLì„ ì¸ë¼ì¸ìœ¼ë¡œ embed
    console.warn('fetch ì‹¤íŒ¨, ì¸ë¼ì¸ spec ì‚¬ìš©:', err);
    loadInlineSpec();
  }
}

// file:// í”„ë¡œí† ì½œì—ì„œ fetchê°€ ë¶ˆê°€í•  ë•Œ ì¸ë¼ì¸ YAML ë¡œë“œ
function loadInlineSpec() {
  const specText = document.getElementById('inline-spec').textContent;
  const spec = jsyaml.load(specText);

  SwaggerUIBundle({
    spec,
    dom_id: '#swagger-ui',
    presets: [
      SwaggerUIBundle.presets.apis,
      SwaggerUIStandalonePreset
    ],
    layout: 'StandaloneLayout',
    deepLinking: true,
    displayRequestDuration: true,
    filter: true,
    tryItOutEnabled: true,
    withCredentials: true,
  });
}

loadSpec();
</script>

<!-- file:// í”„ë¡œí† ì½œ fallbackìš© ì¸ë¼ì¸ spec (ìµœì†Œ ë²„ì „) -->
<script type="text/plain" id="inline-spec">
openapi: 3.0.3
info:
  title: TraceTag Platform API
  version: 1.0.0
  description: |
    BLE ìì‚° ì¶”ì  í”Œë«í¼ REST API.
    ì „ì²´ specì€ openapi.yaml íŒŒì¼ì„ ì°¸ì¡°í•˜ì„¸ìš”.
    HTTP ì„œë²„ë¥¼ í†µí•´ index.htmlì„ ì„œë¹™í•˜ë©´ ì „ì²´ specì´ ìë™ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤.

    **ë¡œì»¬ì—ì„œ ì „ì²´ spec ë³´ê¸°:**
    ```
    npx serve swagger/
    ```
    ë˜ëŠ”
    ```
    cd swagger && python3 -m http.server 8888
    ```
servers:
  - url: http://localhost:3000/api
    description: ë¡œì»¬ ê°œë°œ ì„œë²„
paths:
  /gateways:
    get:
      tags: [Gateways]
      summary: ê²Œì´íŠ¸ì›¨ì´ ëª©ë¡ ì¡°íšŒ
      responses:
        '200':
          description: OK
  /tags:
    get:
      tags: [Tags]
      summary: íƒœê·¸ ëª©ë¡ ì¡°íšŒ
      responses:
        '200':
          description: OK
</script>

</body>
</html>
